"use strict";const baseUrl="/tickets";var wrapper;KTUtil.onDOMContentLoaded(function(){wrapper=new Vue({el:"#kt_content_container",data:{tickets:[],ticketMessages:[],currentTicket:{id:-1,priority:-1,status:-1,title:"",totalMessages:-1,updatedAt:"",updatedAtFormatted:"",user:"",userId:-1},search:"",loadingMessages:!1},created:function(){this.GetTickets(this.search);this.SetRelativeTime();document.onkeydown=function(n){n=n||window.event;var t=!1;t="key"in n?n.key==="Escape"||n.key==="Esc":n.keyCode===27;t&&wrapper.CloseChat()};setTimeout(()=>{let n=document.getElementById("kt_chat_messenger_input");n.addEventListener("keydown",function(){(event.keyCode==10||event.keyCode==13)&&event.ctrlKey&&wrapper.SendChatMessage()})},1234)},watch:{search:function(n){wrapper.GetTickets(n)}},methods:{GetTickets:function(n){fetch(`${baseUrl}/getdata?search=${n}`,{method:"GET"}).then(n=>n.json()).then(n=>{wrapper.tickets=n,KTApp.initBootstrapTooltips()}).catch(n=>toastr.error(n.message))},SetRelativeTime:function(){setInterval(function(){document.querySelectorAll("span[data-refresh='yes']").forEach(n=>n.innerHTML=moment(n.dataset.momentUpdate,"YYYY-MM-DDThh:mm:ss").locale("fa").fromNow())},1e3)},ShowTicket:function(n){wrapper.CloseChat();this.loadingMessages=!0;fetch(`${baseUrl}/details/${n}`,{method:"GET"}).then(n=>n.json()).then(n=>{wrapper.currentTicket=n.details,wrapper.ticketMessages=n.messages,this.loadingMessages=!1}).then(()=>{KTUtil.scrollTo(document.getElementById("kt_chat_messenger"),100,456),setTimeout(()=>wrapper.ScrollChat(),456)}).catch(n=>toastr.error(n.message))},SendChatMessage:function(){let n=document.getElementById("kt_chat_messenger_input");if(!(n.value.length<1)){let t=new FormData;t.append("ticketId",wrapper.currentTicket.id);t.append("message",n.value);fetch(`${baseUrl}/addmessage`,{method:"POST",body:t}).then(n=>n.json()).then(n=>{wrapper.ticketMessages.push(n),wrapper.currentTicket.status==0&&(wrapper.currentTicket.status=2,wrapper.tickets.find(n=>n.id==wrapper.currentTicket.id).status=2)}).then(()=>{wrapper.ScrollChat()}).catch(n=>toastr.error(n.message));n.value=""}},ScrollChat:function(){let t=document.querySelector("#kt_chat_messenger"),n=t.querySelector('[data-kt-element="messages"]');n.scrollTop=n.scrollHeight},CloseChat:function(){wrapper.ticketMessages=[];wrapper.currentTicket={id:-1,priority:-1,status:-1,title:"",totalMessages:-1,updatedAt:"",updatedAtFormatted:"",user:"",userId:-1}},CloseTicket:function(){SwalConfirm.fire().then(function(n){n.value&&fetch(`${baseUrl}/close?id=${wrapper.currentTicket.id}`,{method:"GET"}).then(n=>n.json()).then(n=>{console.log(n),wrapper.CloseChat(),wrapper.GetTickets("")}).catch(n=>toastr.error(n.message))})}}})});